import{am as T,d as de,r as m,R as _e,ag as fe,N as O,h as u,c as p,e,w as l,J as I,a as n,i as v,t as o,B as y,F as $,O as H,u as i,k as s,a9 as F,m as W,aV as ve,a5 as G,P as Q,aw as X,S as ge,az as me,a4 as he,E as xe,aq as ke,ar as ye,T as we,aW as Ce,V as Te,p as be,g as Ee}from"./index-ac08d87d.js";/* empty css                  *//* empty css                   */import{T as Ve,_ as Be}from"./dark-3f3f8889.js";/* empty css               *//* empty css                  *//* empty css                     *//* empty css                 */import{b as Ue}from"./module-8f8bb8a7.js";import{_ as Se}from"./_plugin-vue_export-helper-c27b6911.js";function Ie(c=""){return T.get(c?`upgrade/${c}`:"upgrade")}function $e(){return T.get("upgrade/task")}function Fe(c=""){return T.post(c?`upgrade/${c}`:"upgrade")}function Me(){return T.post("upgrade/execute",{})}function Ne(c=""){return T.get(c?`upgrade/check/${c}`:"upgrade/check")}function Y(){return T.post("upgrade/clear")}const Le=c=>(be("data-v-eea40a80"),c=c(),Ee(),c),De={key:0,class:"h-[60vh] flex flex-col"},He={class:"text-lg"},Re={class:"font-bold"},je={class:"font-bold"},qe={key:0,class:"mt-[10px]"},Ae=Le(()=>n("a",{class:"text-primary",href:"https://www.niucloud.com",target:"_blank"},"niucloud-admin官网",-1)),Pe={class:"font-bold text-lg"},ze={key:0,class:"mt-[5px]"},Je=["innerHTML"],Ke={key:1,class:"flex justify-end"},Oe={key:0,class:"h-[60vh] flex flex-col"},We={key:0,class:"bg-[#fff] my-3"},Ge={class:"pt-[20px] pl-[20px]"},Qe={class:"px-[20px] pt-[10px] text-[14px] el-table"},Xe={key:0},Ye={key:1},Ze={key:0},ea={key:1},aa={class:"h-[60vh]"},ta={class:"h-[60vh] flex flex-col"},la={class:"flex-1 h-0"},sa={class:"flex justify-end"},na=["innerHTML"],oa={class:"flex justify-end"},ra=de({__name:"index",emits:["complete","cloudbuild"],setup(c,{expose:Z,emit:R}){const _=m(!1),d=m(null),g=m(null),h=m("content"),b=m(null),w=m(!1),E=m(null),V=m(!1);let M=[],N=[];const U=()=>{$e().then(({data:t})=>{if(t){if(!_.value){ae();return}if(g.value||(E.value.execute("clear"),E.value.execute("开始升级")),t.log.forEach(a=>{M.includes(a)||(E.value.pushMessage({content:`正在执行：${a}`}),M.push(a))}),t.error&&t.error.forEach(a=>{N.includes(a)||(E.value.pushMessage({content:a,class:"error"}),N.push(a))}),t.step!="restoreComplete"){if(t.step=="upgradeComplete"){h.value="complete",B&&B.close(),R("complete"),Y();return}g.value=t,ee()}}}).catch()};U();const ee=()=>{Me().then(()=>{U()}).catch()};let B=null;const ae=()=>{B=ve.success({title:s("warning"),dangerouslyUseHTMLString:!0,message:G("div",{},[s("upgrade.upgradingTips"),G("span",{class:"text-primary cursor-pointer",onClick:te},[s("upgrade.clickView")])]),duration:0,showClose:!1})},te=()=>{_.value=!0,h.value="upgrade",U(),B&&B.close()},j=m("");_e().then(t=>{j.value=t.data.version.version});const q=m("");Ue().then(({data:t})=>{q.value=t.last_version});const le=async()=>{var a,x;if(w.value)return;w.value=!0;const t=((a=d.value)==null?void 0:a.app.app_key)!="niucloud-admin"?(x=d.value)==null?void 0:x.app.app_key:"";await Ne(t).then(async({data:C})=>{C.is_pass?await Fe(t).then(()=>{U()}).catch(()=>{w.value=!1}):b.value=C}).catch(),w.value&&(h.value="upgrade")},se=(t="")=>{if(g.value)Q({message:"已有正在执行中的升级任务",type:"error"}),_.value=!0;else{if(t&&j.value!=q.value){Q({message:"存在新版本框架，请先升级框架",type:"error"});return}Ie(t).then(({data:a})=>{d.value=a,X.get("upgradeTipsLock")?_.value=!0:V.value=!0}).catch()}};let L=null;const A=new Ve,ne=(t,a,x,C,k)=>{if(a=="开始升级"){x(A);const f=oe(["/","——","\\","|"]);L=setInterval(()=>{A.flush("> "+f.next().value)},150)}},oe=t=>{var a=0;return{next(){return a+1==t.length&&(a=0),{value:t[a++]}}}},re=t=>{h.value=="upgrade"&&g.value&&!g.value.error?ge.confirm(s("upgrade.showDialogCloseTips"),s("warning"),{confirmButtonText:s("confirm"),cancelButtonText:s("cancel"),type:"warning"}).then(()=>{t()}).catch(()=>{}):t()};fe(()=>_.value,()=>{_.value||ue()});const ue=()=>{h.value="content",w.value=!1,g.value=null,M=[],N=[],L&&clearInterval(L),Y().then(()=>{}).catch()},ie=()=>{_.value=!1,R("cloudbuild")},P=(t=!1)=>{t&&X.set({key:"upgradeTipsLock",data:t}),V.value=!1,!t&&(_.value=!0)};return Z({open:se}),(t,a)=>{const x=me,C=he,k=xe,f=ke,D=ye,z=O("Select"),S=we,J=O("CloseBold"),pe=Ce,K=Te;return u(),p($,null,[e(K,{modelValue:_.value,"onUpdate:modelValue":a[1]||(a[1]=r=>_.value=r),title:i(s)("upgrade.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":re},{default:l(()=>[I(n("div",null,[d.value?(u(),p("div",De,[n("div",He,[v(" 本次升级将从"),n("span",Re,o(d.value.version),1),v("升级到"),n("span",je,o(d.value.upgrade_version),1),v("版本 ")]),d.value.upgrade_version!=d.value.last_version?(u(),p("div",qe,[e(x,{type:"info","show-icon":""},{title:l(()=>[v(" 当前最新版本为"+o(d.value.last_version)+"，您的服务"+o(d.value.expire_time?`已于${d.value.expire_time}到期`:"长期有效")+"。如需升级到最新版可在",1),Ae,v("购买相关服务后再进行升级 ")]),_:1})])):y("",!0),e(C,{class:"flex-1 h-0 mt-[20px]"},{default:l(()=>[(u(!0),p($,null,H(d.value.version_list,(r,ce)=>(u(),p("div",{class:"mt-[20px]",key:ce},[n("div",Pe,o(r.version_no),1),r.release_time?(u(),p("div",ze,o(r.release_time),1)):y("",!0),r.upgrade_log?(u(),p("div",{key:1,class:"mt-[10px] p-[10px] rounded bg-[#f4f4f5] whitespace-pre-wrap !break-all",innerHTML:r.upgrade_log},null,8,Je)):y("",!0)]))),128))]),_:1})])):y("",!0),d.value.version_list.length?(u(),p("div",Ke,[e(k,{type:"primary",onClick:le,loading:w.value},{default:l(()=>[v(o(i(s)("upgrade.upgradeButton")),1)]),_:1},8,["loading"])])):y("",!0)],512),[[F,h.value=="content"]]),I(n("div",null,[b.value&&!g.value?(u(),p("div",Oe,[e(C,null,{default:l(()=>[b.value.dir?(u(),p("div",We,[n("p",Ge,o(i(s)("upgrade.dirPermission")),1),n("div",Qe,[e(D,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(f,{span:12},{default:l(()=>[n("span",null,o(i(s)("upgrade.path")),1)]),_:1}),e(f,{span:6},{default:l(()=>[n("span",null,o(i(s)("upgrade.demand")),1)]),_:1}),e(f,{span:6},{default:l(()=>[n("span",null,o(i(s)("status")),1)]),_:1})]),_:1}),(u(!0),p($,null,H(b.value.dir.is_readable,r=>(u(),W(D,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(f,{span:12},{default:l(()=>[n("span",null,o(r.dir),1)]),_:2},1024),e(f,{span:6},{default:l(()=>[n("span",null,o(i(s)("upgrade.readable")),1)]),_:1}),e(f,{span:6},{default:l(()=>[r.status?(u(),p("span",Xe,[e(S,{color:"green"},{default:l(()=>[e(z)]),_:1})])):(u(),p("span",Ye,[e(S,{color:"red"},{default:l(()=>[e(J)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(u(!0),p($,null,H(b.value.dir.is_write,r=>(u(),W(D,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(f,{span:12},{default:l(()=>[n("span",null,o(r.dir),1)]),_:2},1024),e(f,{span:6},{default:l(()=>[n("span",null,o(i(s)("upgrade.write")),1)]),_:1}),e(f,{span:6},{default:l(()=>[r.status?(u(),p("span",Ze,[e(S,{color:"green"},{default:l(()=>[e(z)]),_:1})])):(u(),p("span",ea,[e(S,{color:"red"},{default:l(()=>[e(J)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):y("",!0)]),_:1})])):y("",!0),I(n("div",aa,[e(i(Be),{ref_key:"terminalRef",ref:E,context:g.value?g.value.upgrade.app_key:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:ne},null,8,["context"])],512),[[F,g.value]])],512),[[F,h.value=="upgrade"]]),I(n("div",null,[n("div",ta,[n("div",la,[e(pe,{icon:"success",title:i(s)("upgrade.upgradeSuccess")},null,8,["title"]),e(x,{title:i(s)("upgrade.upgradeCompleteTips"),type:"error",closable:!1},null,8,["title"])]),n("div",sa,[e(k,{type:"default",onClick:a[0]||(a[0]=r=>_.value=!1)},{default:l(()=>[v(o(i(s)("upgrade.localBuild")),1)]),_:1}),e(k,{type:"primary",onClick:ie},{default:l(()=>[v(o(i(s)("upgrade.cloudBuild")),1)]),_:1})])])],512),[[F,h.value=="complete"]])]),_:1},8,["modelValue","title"]),e(K,{modelValue:V.value,"onUpdate:modelValue":a[5]||(a[5]=r=>V.value=r),title:i(s)("warning"),width:"500px",draggable:""},{footer:l(()=>[n("div",oa,[e(k,{onClick:a[2]||(a[2]=r=>P(!0)),type:"primary"},{default:l(()=>[v(o(i(s)("upgrade.knownToKnow")),1)]),_:1}),e(k,{onClick:a[3]||(a[3]=r=>P()),type:"primary",plain:""},{default:l(()=>[v(o(i(s)("upgrade.upgradeButton")),1)]),_:1}),e(k,{onClick:a[4]||(a[4]=r=>V.value=!1)},{default:l(()=>[v(o(i(s)("cancel")),1)]),_:1})])]),default:l(()=>[n("span",{innerHTML:i(s)("upgrade.upgradeTips")},null,8,na)]),_:1},8,["modelValue","title"])],64)}}});const ha=Se(ra,[["__scopeId","data-v-eea40a80"]]);export{ha as default};
